name: Release Code Quality Final Review

on:
    push:
        tags: ['v*']

permissions:
    contents: write

jobs:
    build-and-release:
        runs-on: ubuntu-latest

        steps:
            # Step 1: Check out the repository's code.
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            # Step 2: Set up Git for local operations only
            - name: Set up Git
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  echo "ðŸ”§ Git configured for local operations (no push to protected branch)"

            # Step 3: Get the version number from the tag.
            - name: Get the version from the tag
              id: get_version
              run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

            # Step 4: Update version numbers in all files.
            - name: Update version numbers
              run: |
                  # 1. Update package.json version
                  sed -i -E 's/("version":\s*").*(")/\1'${{ env.VERSION }}'\2/' package.json
                  
                  # 2. Update main plugin header version (Root file)
                  sed -i -E "s/^(\s*\* Version:\s*).*/\1${{ env.VERSION }}/" sparxstar-3iatlas-dictionary.php
                  sed -i "s/define( 'SPARX_3IATLAS_VERSION', '[^']*' );/define( 'SPARX_3IATLAS_VERSION', '${{ env.VERSION }}' );/" sparxstar-3iatlas-dictionary.php
                  
                  # 3. Update @version tags in ALL PHP source files under src/
                  find src/ -type f -name "*.php" -print0 | xargs -0 sed -i "s/@version\s\+[0-9.]\+/@version ${{ env.VERSION }}/g"

            # Step 5: Verify version numbers were applied successfully
            - name: Verify version numbers in key files
              run: |
                  echo "ðŸ“‹ Verifying version ${{ env.VERSION }} was applied to key files:"
                  
                  # Verify plugin header version (allows multiple spaces after Version:)
                  grep -q "Version:[[:space:]]*${{ env.VERSION }}" sparxstar-3iatlas-dictionary.php || { 
                      echo "âŒ Plugin header version not found or incorrect"; 
                      grep "Version:" sparxstar-3iatlas-dictionary.php || echo "No Version: line found";
                      exit 1; 
                  }
                  echo "âœ… Plugin header version verified"
                  
                  # Verify version constant (matches single quotes as used in the actual code)
                  grep -q "SPARX_3IATLAS_VERSION', '${{ env.VERSION }}'" sparxstar-3iatlas-dictionary.php || { 
                      echo "âŒ Version constant not found or incorrect"; 
                      grep "SPARX_3IATLAS_VERSION" sparxstar-3iatlas-dictionary.php || echo "No SPARX_3IATLAS_VERSION found";
                      exit 1; 
                  }
                  echo "âœ… Version constant verified"
                  
                  # Verify package.json version (matches exact JSON structure with double quotes)
                  grep -q '"version":[[:space:]]*"${{ env.VERSION }}"' package.json || { 
                      echo "âŒ Package.json version not found or incorrect"; 
                      grep '"version"' package.json || echo "No version field found";
                      exit 1; 
                  }
                  echo "âœ… Package.json version verified"
                  
                  echo "âœ… All version numbers verified successfully"

            # Step 6: Prepare version changes (no commit)
            - name: Prepare version changes for release build
              run: |
                  echo "ðŸ“ Version changes prepared for release build:"
                  git diff --stat || echo "No version changes detected"

            # Step 7: Verify plugin entrypoint exists.
            - name: Verify plugin entrypoint
              run: |
                  test -f sparxstar-3iatlas-dictionary.php || { echo "Missing sparxstar-3iatlas-dictionary.php"; exit 1; }
                  grep -q "Plugin Name:" sparxstar-3iatlas-dictionary.php || { echo "No plugin header found"; exit 1; }

            # Step 8: Set up PHP and install Composer dependencies.
            - name: Set up PHP
              uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1
              with:
                  php-version: '8.2'
                  tools: composer:v2
                  coverage: none
            - name: Install PHP dependencies (no-dev)
              run: composer install --no-dev --prefer-dist --no-progress --no-interaction --optimize-autoloader

            # Step 9: Set up Node.js and build frontend assets.
            # Using Node 20 (LTS) for Webpack/Tailwind compatibility
            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install JS dependencies
              run: npm ci

            - name: Build Assets
              run: npm run build
            
            # Step 9b: Verify Assets (Built files in assets/)
            - name: Verify build output
              run: |
                  test -f assets/js/sparxstar-3iatlas-dictionary-admin.min.js || { echo "Missing admin JS"; exit 1; }
                  test -f assets/css/sparxstar-3iatlas-dictionary-admin-style.min.css || { echo "Missing admin CSS"; exit 1; }
                  test -f assets/js/sparxstar-3iatlas-dictionary-app.min.js || { echo "Missing app JS"; exit 1; }
                  test -f assets/css/sparxstar-3iatlas-dictionary-app.min.css || { echo "Missing app CSS"; exit 1; }
                  test -f assets/js/sparxstar-3iatlas-dictionary-form.min.js || { echo "Missing form JS"; exit 1; }
                  test -f assets/css/sparxstar-3iatlas-dictionary-form-style.min.css || { echo "Missing form CSS"; exit 1; }
                  echo "âœ… All required build artifacts present"

            # Step 10: Build the distributable plugin ZIP file.
            - name: Ensure .distignore exists
              run: test -f .distignore || { echo ".distignore is missing"; exit 1; }

            - name: Verify production files are ready
              run: |
                  echo "ðŸ” Verifying production-ready files..."
                  test -f sparxstar-3iatlas-dictionary.php || { echo "âŒ Missing plugin main file"; exit 1; }
                  # Verify we have both Source AND Assets
                  test -d src/ || { echo "âŒ Missing src/ directory"; exit 1; }
                  test -d assets/ || { echo "âŒ Missing assets/ directory"; exit 1; }
                  test -f vendor/autoload.php || { echo "âŒ Missing Composer autoloader"; exit 1; }
                  echo "âœ… All production files verified"

            - name: Build plugin ZIP
              run: |
                  SLUG="sparxstar-3iatlas-dictionary"
                  VERSION=${{ env.VERSION }}
                  echo "ðŸ—ï¸ Building release ZIP with version $VERSION"

                  rm -rf build
                  mkdir -p build
                  
                  # IMPORTANT: Check your .distignore file!
                  # Ensure it DOES NOT contain 'src/' or 'assets/' 
                  # so that both built and un-built files are included.
                  rsync -a --exclude-from=.distignore ./ build/${SLUG}/
                  
                  (cd build && zip -r "../${SLUG}-${VERSION}.zip" "${SLUG}")

                  echo "ðŸ“¦ Release ZIP created: ${SLUG}-${VERSION}.zip"

            # Ensure vendor exists
            - name: Ensure vendor directory is preserved for ZIP
              run: |
                  if [ ! -d "vendor" ]; then
                    echo "Vendor directory missing â€” Composer install did not create it."
                    exit 1
                  fi

            # Step 11: Generate checksums for the ZIP file.
            - name: Generate checksums
              run: |
                  ZIP_FILE="sparxstar-3iatlas-dictionary-${{ env.VERSION }}.zip"
                  sha256sum "$ZIP_FILE" > "$ZIP_FILE.sha256"
                  sha1sum   "$ZIP_FILE" > "$ZIP_FILE.sha1"

            # Step 12: Create GitHub Release
            - name: Create GitHub Release
              uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
              with:
                  files: |
                      sparxstar-3iatlas-dictionary-${{ env.VERSION }}.zip
                      sparxstar-3iatlas-dictionary-${{ env.VERSION }}.zip.sha256
                      sparxstar-3iatlas-dictionary-${{ env.VERSION }}.zip.sha1
